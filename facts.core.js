// https://pinkturtle.github.io/facts version 0.0.0
// Requires https://facebook.github.io/immutable-js
// ••••••••••••••••••••••••••••••••••••••••••••••••
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.Facts=t()}}(function(){var t,e,n;return function t(e,n,i){function r(s,u){if(!n[s]){if(!e[s]){var a=typeof require=="function"&&require;if(!u&&a)return a(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};e[s][0].call(l.exports,function(t){var n=e[s][1][t];return r(n?n:t)},l,l.exports,t,e,n,i)}return n[s].exports}var o=typeof require=="function"&&require;for(var s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){(function(){var n;n=t("immutable");e.exports=function(t,e){var i,r,o,s;if(e==="now"){e=void 0}r=t.datoms.filterNot(function(t){return/T[0-9]+/.test(t.get(1))});if(e){r=r.filter(function(t){return e>=Number(t.get(4).slice(1))})}s=r.filter(function(t){return t.get(0)===false});r=r.filter(function(t){var e;e=s.find(function(e){return e.get(1)===t.get(1)&&e.get(2)===t.get(2)&&e.get(3)===t.get(3)&&Number(e.get(4).slice(1))>=Number(t.get(4).slice(1))});if(e){return false}else{return true}});i=n.Set();o={};r.forEach(function(t){var e;if(o[e=t.get(1)]==null){o[e]={}}if(o[t.get(1)][t.get(2)]===void 0){o[t.get(1)][t.get(2)]=t.get(3);return i=i.add(t)}});return i}}).call(this)},{immutable:undefined}],2:[function(t,e,n){(function(){var t,n,i,r,o,s,u,a,c;e.exports=t={};n=/\s+/;i=function(t,e,r,o,s){var u,a;u=0;a=void 0;if(r&&typeof r==="object"){if(o!==void 0&&"context"in s&&s.context===void 0){s.context=o}a=Object.keys(r);while(u<a.length){e=i(t,e,a[u],r[a[u]],s);u++}}else if(r&&n.test(r)){a=r.split(n);while(u<a.length){e=t(e,a[u],o,s);u++}}else{e=t(e,r,o,s)}return e};t.on=function(t,e,n){return r(this,t,e,n)};r=function(t,e,n,r,o){var u;t._events=i(s,t._events||{},e,n,{context:r,ctx:t,listening:o});if(o){u=t._listeners||(t._listeners={});u[o.id]=o}return t};t.listenTo=function(t,e,n){var i,o,s,u;if(!t){return this}i=t._listenId||(t._listenId=_.uniqueId("l"));s=this._listeningTo||(this._listeningTo={});o=s[i];if(!o){u=this._listenId||(this._listenId=_.uniqueId("l"));o=s[i]={obj:t,objId:i,id:u,listeningTo:s,count:0}}r(t,e,n,this,o);return this};s=function(t,e,n,i){var r,o,s,u;if(n){s=t[e]||(t[e]=[]);r=i.context;o=i.ctx;u=i.listening;if(u){u.count++}s.push({callback:n,context:r,ctx:r||o,listening:u})}return t};t.off=function(t,e,n){if(!this._events){return this}this._events=i(o,this._events,t,e,{context:n,listeners:this._listeners});return this};t.stopListening=function(t,e,n){var i,r,o,s;s=this._listeningTo;if(!s){return this}r=t?[t._listenId]:Object.keys(s);i=0;while(i<r.length){o=s[r[i]];if(!o){break}o.obj.off(e,n,this);i++}return this};o=function(t,e,n,i){var r,o,s,u,a,c,l,f,h,d;if(!t){return}u=0;f=void 0;r=i.context;l=i.listeners;if(!e&&!n&&!r){a=Object.keys(l);while(u<a.length){f=l[a[u]];delete l[f.id];delete f.listeningTo[f.objId];u++}return}h=e?[e]:Object.keys(t);while(u<h.length){e=h[u];s=t[e];if(!s){break}d=[];c=0;while(c<s.length){o=s[c];if(n&&n!==o.callback&&n!==o.callback._callback||r&&r!==o.context){d.push(o)}else{f=o.listening;if(f&&--f.count===0){delete l[f.id];delete f.listeningTo[f.objId]}}c++}if(d.length){t[e]=d}else{delete t[e]}u++}return t};t.once=function(t,e,n){var r;r=i(u,{},t,e,Function.bind(this.off,this));if(typeof t==="string"&&n===null){e=void 0}return this.on(r,e,n)};t.listenToOnce=function(t,e,n){var r;r=i(u,{},e,n,Function.bind(this.stopListening,this,t));return this.listenTo(t,r)};u=function(t,e,n,i){var r;if(n){r=t[e]=_.once(function(){i(e,r);n.apply(this,arguments)});r._callback=n}return t};t.trigger=function(t){var e,n,r;if(!this._events){return this}r=Math.max(0,arguments.length-1);e=Array(r);n=0;while(n<r){e[n]=arguments[n+1];n++}i(a,this._events,t,void 0,e);return this};a=function(t,e,n,i){var r,o;if(t){o=t[e];r=t.all;if(o&&r){r=r.slice()}if(o){c(o,i)}if(r){c(r,[e].concat(i))}}return t};c=function(t,e){var n,i,r,o,s,u;o=void 0;s=-1;u=t.length;n=e[0];i=e[1];r=e[2];switch(e.length){case 0:while(++s<u){(o=t[s]).callback.call(o.ctx)}return;case 1:while(++s<u){(o=t[s]).callback.call(o.ctx,n)}return;case 2:while(++s<u){(o=t[s]).callback.call(o.ctx,n,i)}return;case 3:while(++s<u){(o=t[s]).callback.call(o.ctx,n,i,r)}return;default:while(++s<u){(o=t[s]).callback.apply(o.ctx,e)}return}};t.dispatch=t.trigger}).call(this)},{}],3:[function(t,e,n){(function(){var n,i,r,o,s,u;n=t("./events");r=(typeof window!=="undefined"&&window!==null?window["Immutable"]:void 0)||t("immutable");i=function(){function t(){if(this instanceof t){this.initialize();return this}else{return new t}}t.prototype.initialize=function(){};t.prototype.datoms=r.Stack();t.prototype.historyIndex=0;t.prototype.history=r.List([r.Set()]);t.prototype.at=function(e){return t.database(this,e)};t.prototype.query=function(e){var n;if(e==null){e={}}n=e["at"];delete e["at"];e["in"]=this.at(n);return t.query(e)};t.prototype.pull=function(t){return this.query({where:function(e){return e===t}})[0]};t.prototype.advance=function(t,e){var n,i;return this.transact(function(){var r;r=[];for(n in e){i=e[n];r.push(["advance",t,n,i])}return r}())};t.prototype.reverse=function(t,e){var n,i;return this.transact(function(){var r;r=[];for(n in e){i=e[n];r.push(["reverse",t,n,i])}return r}())};t.prototype.unknown=function(t,e){var n,i;return this.transact(function(){var r;r=[];for(n in e){i=e[n];r.push(["unknown",t,n,i])}return r}())};t.prototype.transact=function(e,n){return t.transact(this,e,n)};return t}();u=t("./events");for(o in u){s=u[o];i.prototype[o]=s}i.prototype.database=i.prototype.asOf=i.prototype.at;i.prototype.divert=i.prototype.assert=i.prototype.add=i.prototype.advance;i.prototype.revert=i.prototype.retract=i.prototype.subtract=i.prototype.reverse;i.prototype.unsure=i.prototype.unknown;i.prototype.get=i.prototype.recall=i.prototype.retrieve=i.prototype.pull;i.Immutable=r;i.construct=i.apply;i.database=t("./database");i.query=t("./query");i.transact=t("./transact");e.exports=i}).call(this)},{"./database":1,"./events":2,"./query":4,"./transact":5,immutable:undefined}],4:[function(t,e,n){(function(){var n,i;n=t("immutable");e.exports=function(t){var e,n,r,o,s,u,a;e=t["in"];u=(a=t["out"])!=null?a:"list";s={};if(t["where"]){e=e.filter(function(e){return t["where"](e.get(1),e.get(2),e.get(3))})}n=e.reduce(i,{});if(u==="map"){return n}if(u==="list"){return function(){var t;t=[];for(o in n){r=n[o];t.push(r)}return t}()}throw"'"+u+"' is not a recognized query output format. Try out:'list' or out:'map'."};i=function(t,e){var n,i;if(t[i=e.get(1)]==null){t[i]={}}t[e.get(1)]["id"]=e.get(1);t[e.get(1)][e.get(2)]=(n=e.get(3)).toJS!=null?n.toJS():n;return t}}).call(this)},{immutable:undefined}],5:[function(t,e,n){(function(n){(function(){var i,r,o,s,u,a,c;i=t("immutable");e.exports=function(t,e,n){var r,u,l,f,h,d;if(n==null){n=s()}if(typeof(e!=null?e.map:void 0)!=="function"){throw"Facts.transact can’t create a transaction without a list of input."}if(e.length===0){throw"Facts.transact can’t create a transaction with an empty list of input data."}d="T"+n;h={time:n};u=a.call(t);l=e.map(function(t){return i.fromJS([c(t[0]),o.call(this,t),t[2],t[3],d])});t.datoms=t.datoms.pushAll(l);t.datoms=t.datoms.pushAll(i.fromJS([[true,d,"time",n,d]]));t.history=t.history.push(r=t.at());t.historyIndex=t.history.count()-1;f={transaction:d,"db before":u,"db after":r,data:l};t.dispatch("transaction",f);return f};o=function(t){var e;e=t[1];if(e===void 0){return this.maxEntityId+=1}else{return e}};a=function(){if(this.history.last().hashCode()!==this.history.get(this.historyIndex).hashCode()){console.info("Pushing Old Database to end");this.history=this.history.push(this.history.get(this.historyIndex));this.historyIndex=history.count()-1;return this.history.last()}else{return this.history.last()}};c=function(t){if(t==="advance"){return true}if(t==="reverse"){return false}if(t==="unknown"){return void 0}throw"Oops! '"+t+"' is not a recognized transaction operation. Try 'advance', 'reverse' or 'unknown'."};s=e.exports.now=function(){var t,e;switch(false){case!((typeof window!=="undefined"&&window!==null?(t=window.performance)!=null?t.now:void 0:void 0)instanceof Function):return function(){return performance.timing.navigationStart+performance.now()};case!((typeof n!=="undefined"&&n!==null?(e=n.process)!=null?e.hrtime:void 0:void 0)instanceof Function):u=Date.now();r=function(){var t;t=n.process.hrtime();return t[0]*1e3+t[1]/1e6};return function(){return u+r()};default:throw"Facts couldn’t locate a high-resolution time source in this environment.\n\nA high-resolution time source is required to ensure monotonic transactions.\nFacts checked for window.performance.now and global.process.hrtime but\nneither of these functions was available."}}()}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{immutable:undefined}]},{},[3])(3)});
