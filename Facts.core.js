// https://pinkturtle.github.io/facts version 0.0.0
// Requires https://facebook.github.io/immutable-js
// ••••••••••••••••••••••••••••••••••••••••••••••••
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.Facts=t()}}(function(){var t,e,n;return function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var u=typeof require=="function"&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};e[s][0].call(l.exports,function(t){var n=e[s][1][t];return r(n?n:t)},l,l.exports,t,e,n,i)}return n[s].exports}var o=typeof require=="function"&&require;for(var s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){(function(){var n,i,r,o,s,a=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++){if(e in this&&this[e]===t)return e}return-1};n=t("immutable");e.exports=function(t,e){var i,r,a;a=o(t.datoms,e);r=a.reduce(s(),n.fromJS({datoms:[],entities:{}}));i=n.Stack(r.get("datoms"));i.entities=r.get("entities");return i};o=function(t,e){var n;switch(false){case e.min!==(n=e.max)||n!==void 0:return t;case!(e.max!==void 0&&e.min===void 0):return t.skipUntil(function(t){return t.get(4)<=e.max});case!(e.max===void 0&&e.min!==void 0):return t.takeWhile(function(t){return t.get(4)>=e.min});default:return t.skipUntil(function(t){return t.get(4)<=e.max}).takeWhile(function(t){return t.get(4)>=e.min})}};s=function(){var t,e;t=[false,void 0];e=[];return function(n,o,s){var u;if(i(o)){return n}if((u=o.get(0),a.call(t,u)>=0)&&e.push(o)){return n}if(e.some(function(t){return r(t,o)&&t.get(4)>o.get(4)})){return n}if(n.hasIn(["entities",o.get(1),o.get(2)])){return n}return n.setIn(["datoms"],n.get("datoms").push(o)).setIn(["entities",o.get(1),o.get(2)],o.get(3))}};i=function(t){return i.pattern.test(t.get(1))};i.pattern=/T[0-9]+/;r=function(t,e){return t.get(1)===e.get(1)&&t.get(2)===e.get(2)&&t.get(3)===e.get(3)}}).call(this)},{immutable:undefined}],2:[function(t,e,n){(function(){var t,n,i,r,o,s,a,u,c;e.exports=t={};n=/\s+/;i=function(t,e,r,o,s){var a,u;a=0;u=void 0;if(r&&typeof r==="object"){if(o!==void 0&&"context"in s&&s.context===void 0){s.context=o}u=Object.keys(r);while(a<u.length){e=i(t,e,u[a],r[u[a]],s);a++}}else if(r&&n.test(r)){u=r.split(n);while(a<u.length){e=t(e,u[a],o,s);a++}}else{e=t(e,r,o,s)}return e};t.on=function(t,e,n){return r(this,t,e,n)};r=function(t,e,n,r,o){var a;t._events=i(s,t._events||{},e,n,{context:r,ctx:t,listening:o});if(o){a=t._listeners||(t._listeners={});a[o.id]=o}return t};t.listenTo=function(t,e,n){var i,o,s,a;if(!t){return this}i=t._listenId||(t._listenId=_.uniqueId("l"));s=this._listeningTo||(this._listeningTo={});o=s[i];if(!o){a=this._listenId||(this._listenId=_.uniqueId("l"));o=s[i]={obj:t,objId:i,id:a,listeningTo:s,count:0}}r(t,e,n,this,o);return this};s=function(t,e,n,i){var r,o,s,a;if(n){s=t[e]||(t[e]=[]);r=i.context;o=i.ctx;a=i.listening;if(a){a.count++}s.push({callback:n,context:r,ctx:r||o,listening:a})}return t};t.off=function(t,e,n){if(!this._events){return this}this._events=i(o,this._events,t,e,{context:n,listeners:this._listeners});return this};t.stopListening=function(t,e,n){var i,r,o,s;s=this._listeningTo;if(!s){return this}r=t?[t._listenId]:Object.keys(s);i=0;while(i<r.length){o=s[r[i]];if(!o){break}o.obj.off(e,n,this);i++}return this};o=function(t,e,n,i){var r,o,s,a,u,c,l,f,h,d;if(!t){return}a=0;f=void 0;r=i.context;l=i.listeners;if(!e&&!n&&!r){u=Object.keys(l);while(a<u.length){f=l[u[a]];delete l[f.id];delete f.listeningTo[f.objId];a++}return}h=e?[e]:Object.keys(t);while(a<h.length){e=h[a];s=t[e];if(!s){break}d=[];c=0;while(c<s.length){o=s[c];if(n&&n!==o.callback&&n!==o.callback._callback||r&&r!==o.context){d.push(o)}else{f=o.listening;if(f&&--f.count===0){delete l[f.id];delete f.listeningTo[f.objId]}}c++}if(d.length){t[e]=d}else{delete t[e]}a++}return t};t.once=function(t,e,n){var r;r=i(a,{},t,e,Function.bind(this.off,this));if(typeof t==="string"&&n===null){e=void 0}return this.on(r,e,n)};t.listenToOnce=function(t,e,n){var r;r=i(a,{},e,n,Function.bind(this.stopListening,this,t));return this.listenTo(t,r)};a=function(t,e,n,i){var r;if(n){r=t[e]=_.once(function(){i(e,r);n.apply(this,arguments)});r._callback=n}return t};t.trigger=function(t){var e,n,r;if(!this._events){return this}r=Math.max(0,arguments.length-1);e=Array(r);n=0;while(n<r){e[n]=arguments[n+1];n++}i(u,this._events,t,void 0,e);return this};u=function(t,e,n,i){var r,o;if(t){o=t[e];r=t.all;if(o&&r){r=r.slice()}if(o){c(o,i)}if(r){c(r,[e].concat(i))}}return t};c=function(t,e){var n,i,r,o,s,a;o=void 0;s=-1;a=t.length;n=e[0];i=e[1];r=e[2];switch(e.length){case 0:while(++s<a){(o=t[s]).callback.call(o.ctx)}return;case 1:while(++s<a){(o=t[s]).callback.call(o.ctx,n)}return;case 2:while(++s<a){(o=t[s]).callback.call(o.ctx,n,i)}return;case 3:while(++s<a){(o=t[s]).callback.call(o.ctx,n,i,r)}return;default:while(++s<a){(o=t[s]).callback.apply(o.ctx,e)}return}};t.dispatch=t.trigger}).call(this)},{}],3:[function(t,e,n){(function(){var n,i,r,o,s,a,u,c,l;n=t("./events");u=r=(typeof window!=="undefined"&&window!==null?window["Immutable"]:void 0)||t("immutable"),o=u.List,s=u.Stack;i=function(){function t(e){if(this instanceof t){this.initialize(e);return this}else{return new t(e)}}t.prototype.initialize=function(t){var e,n;if(t==null){t={}}for(e in t){n=t[e];if(e!=="datoms"){this[e]=n}}if(t.datoms){if(s.isStack(t.datoms)){return this.datoms=t.datoms}else{return this.datoms=s(t.datoms.map(o))}}};t.prototype.datoms=s();t.prototype.historyIndex=0;t.prototype.history=o([s()]);t.prototype.now=function(){return t.now()};t.prototype.at=function(e){if(e==="now"){e=void 0}return t.database(this,{max:e,min:void 0})};t.prototype.pull=function(t,e){if(e==null){e={}}if(e.from!=null){e["in"]=e.from}e.where=function(e){return e===t};return this.query(e)[0]};t.prototype.query=function(e){if(e==null){e={}}if(e["in"]==null){e["in"]=[this.at(e.at)]}return t.query(e)};t.prototype.transact=function(e,n){return t.transact(this,e,n)};t.prototype["true"]=function(t,e){var n,i;return this.transact(function(){var r;r=[];for(n in e){i=e[n];r.push([true,t,n,i])}return r}())};t.prototype["false"]=function(t,e){var n,i;return this.transact(function(){var r;r=[];for(n in e){i=e[n];r.push([false,t,n,i])}return r}())};t.prototype.undefined=function(t,e){var n,i;return this.transact(function(){var r;r=[];for(n in e){i=e[n];r.push([void 0,t,n,i])}return r}())};return t}();c=t("./events");for(a in c){l=c[a];i.prototype[a]=l}i.prototype.database=i.prototype.asOf=i.prototype.at;i.prototype.get=i.prototype.entity=i.prototype.recall=i.prototype.retrieve=i.prototype.pull;i.prototype.pleaseAnswerMyQuestion=i.prototype.query;i.prototype.commit=i.prototype.pushState=i.prototype.transact;i.prototype.divert=i.prototype.assert=i.prototype.add=i.prototype.advance=i.prototype["true"];i.prototype.revert=i.prototype.retract=i.prototype.subtract=i.prototype.reverse=i.prototype["false"];i.prototype.unsure=i.prototype.uncertain=i.prototype.unknown=i.prototype.undefined;i.Immutable=r;i.construct=i.apply;i.now=t("./now");i.database=t("./database");i.query=t("./query");i.transact=t("./transact");e.exports=i}).call(this)},{"./database":1,"./events":2,"./now":4,"./query":5,"./transact":6,immutable:undefined}],4:[function(t,e,n){(function(t){(function(){var n,i;e.exports=function(){var e,r;switch(false){case!((typeof window!=="undefined"&&window!==null?(e=window.performance)!=null?e.now:void 0:void 0)instanceof Function):return function(){return performance.timing.navigationStart+performance.now()};case!((typeof t!=="undefined"&&t!==null?(r=t.process)!=null?r.hrtime:void 0:void 0)instanceof Function):i=Date.now();n=function(){var e;e=t.process.hrtime();return e[0]*1e3+e[1]/1e6};return function(){return i+n()};default:throw"Facts couldn’t locate a high-resolution time source in this environment.\n\nA high-resolution time source is required to ensure transactions don’t fall\nout of the pocket and ruin that fine-fine monotonic grooviness. Facts checked\nfor window.performance.now and global.process.hrtime but neither of these\nfunctions was available."}}()}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],5:[function(t,e,n){(function(){var n,i;n=t("immutable");e.exports=function(t){var e,n,r,o,s,a;e=t["in"][0];s=(a=t["out"])!=null?a:Array;if(t["where"]){e=e.filter(function(e){return t["where"](e.get(1),e.get(2),e.get(3))})}n=e.reduce(i,{});if(s===Object){return n}if(s===Array){return function(){var t;t=[];for(o in n){r=n[o];t.push(r)}return t}()}throw"Oops! "+JSON.stringify(s)+" is not a recognized query output format. Try query({out:Array}) or query({out:Object})"};i=function(t,e){var n,i;if(t[n=e.get(1)]==null){t[n]={}}t[e.get(1)]["id"]=e.get(1);t[e.get(1)][e.get(2)]=(i=e.get(3)).toJS!=null?i.toJS():i;return t}}).call(this)},{immutable:undefined}],6:[function(t,e,n){(function(){var n,i,r,o,s;n=t("immutable");e.exports=function(t,e,a){var u,c,l,f,h,d,p,y;if(a==null){a=t.now()}if(typeof(e!=null?e.map:void 0)!=="function"){throw"Facts.transact can’t create a transaction without a list of input."}if(e.length===0){throw"Facts.transact can’t create a transaction with an empty list of input data."}y=e.filter(i).map(function(t){return t[1]});if(y.length!==0){h=y.length===1?"another transaction":y.length+" other transactions";throw"Transaction was aborted because its input contained data that identified "+h+": "+y.join(" ")+"\n\nTransactions may not be explicitly advanced, reversed or unknown because Facts relies on\nthem as its implicit record of what happened when. Facts.transact is the only function\npermitted to construct transactions. Transaction data from other sources will be rejected."}p="T"+a;d={time:a};c=o.call(t);l=e.map(function(t){return n.fromJS([s(t[0]),r.call(this,t),t[2],t[3],a])});t.datoms=t.datoms.pushAll(l);t.datoms=t.datoms.pushAll(n.fromJS([[true,p,"time",a,a]]));t.history=t.history.push(u=t.at());t.historyIndex=t.history.count()-1;f={transaction:p,"db before":c,"db after":u,data:l};t.dispatch("transaction",f);return f};r=function(t){var e;e=t[1];if(e===void 0){return this.maxEntityId+=1}else{return e}};o=function(){if(this.history.last().hashCode()!==this.history.get(this.historyIndex).hashCode()){console.info("Pushing Old Database to end");this.history=this.history.push(this.history.get(this.historyIndex));this.historyIndex=history.count()-1;return this.history.last()}else{return this.history.last()}};s=function(t){if(t===true||t===false||t===void 0){return t}else{throw"Oops! '"+t+"' is not a recognized transaction operation. Try true, false or undefined."}};i=function(t){return i.pattern.test(t[1])};i.pattern=/T[0-9]+/}).call(this)},{immutable:undefined}]},{},[3])(3)});
